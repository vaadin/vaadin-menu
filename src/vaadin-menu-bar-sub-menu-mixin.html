<!--
@license
Copyright (c) 2019 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<script>
  /**
   * @namespace Vaadin
   */
  window.Vaadin = window.Vaadin || {};

  /**
   * @namespace Vaadin.MenuBar
   */
  window.Vaadin.MenuBar = window.Vaadin.MenuBar || {};

  /**
   * @polymerMixin
   */
  Vaadin.MenuBar.SubMenuMixin = superClass => class SubMenuMixin extends superClass {

    constructor() {
      super();
      this.__boundOutsideClickListener = this.__outsideClickListener.bind(this);
      this.__boundOnContextMenuKeydown = this.__onContextMenuKeydown.bind(this);
    }

    static get observers() {
      return [
        '_itemsChanged(items, items.splices)'
      ];
    }

    ready() {
      super.ready();

      this.shadowRoot.addEventListener('button-click', this.__onButtonClick.bind(this));

      this._subMenu.addEventListener('item-selected', this.__onItemSelected.bind(this));
      this._subMenu.addEventListener('close-all-menus', this.__onEscapeClose.bind(this));

      const overlay = this._subMenu.$.overlay;
      overlay.modeless = true;
      overlay.addEventListener('keydown', this.__boundOnContextMenuKeydown);
      overlay.addEventListener('vaadin-overlay-open', this.__alignOverlayPosition.bind(this));
    }

    connectedCallback() {
      super.connectedCallback();
      document.addEventListener('click', this.__boundOutsideClickListener, true);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      document.removeEventListener('click', this.__boundOutsideClickListener, true);
    }

    get _subMenu() {
      return this.shadowRoot.querySelector('vaadin-context-menu');
    }

    __alignOverlayPosition(e) {
      const overlay = e.target;
      const getRect = () => this._activeButton.getBoundingClientRect();
      if (overlay.hasAttribute('bottom-aligned')) {
        overlay.style.bottom = parseInt(getComputedStyle(overlay).bottom) + getRect().height + 'px';
      }
      if (overlay.hasAttribute('right-aligned')) {
        overlay.style.right = parseInt(getComputedStyle(overlay).right) - getRect().width + 'px';
      }
    }

    _itemsChanged(items, splices) {
      const subMenu = this._subMenu;
      if (subMenu && subMenu.opened) {
        subMenu.close();
      }
    }

    __onContextMenuKeydown(e) {
      const item = e.target;
      const list = item.parentNode;
      if (e.keyCode === 38 && item === list.items[0]) {
        this._close(true);
      }
    }

    __outsideClickListener(e) {
      if (e.composedPath().indexOf(this) === -1) {
        this._close();
      }
    }

    __fireItemSelected(value) {
      this.dispatchEvent(new CustomEvent('item-selected', {detail: {value}}));
    }

    __onButtonClick(e) {
      e.stopPropagation();
      const button = e.composedPath()[0];
      const subMenu = this._subMenu;

      if (subMenu.opened) {
        this._close();
        if (subMenu.listenOn === button) {
          return;
        }
      }

      const {item} = e.detail;
      const items = item && item.children;
      if (!items || items.length === 0) {
        this.__fireItemSelected(item);
        return;
      }

      subMenu.items = items;
      subMenu.listenOn = button;
      this._activeButton = button;

      const rect = button.getBoundingClientRect();

      requestAnimationFrame(() => {
        button.dispatchEvent(new CustomEvent('opensubmenu', {detail: {
          x: rect.left,
          y: rect.bottom,
          children: items
        }}));

        button.setAttribute('expanded', '');
      });
    }

    __onItemSelected(e) {
      e.stopPropagation();
      this._close();
      this.__fireItemSelected(e.detail.value);
    }

    __onEscapeClose(e) {
      this.__deactivateButton(true);
    }

    __deactivateButton(restoreFocus) {
      const button = this._activeButton;
      if (button && button.hasAttribute('expanded')) {
        button.removeAttribute('expanded');
        if (restoreFocus) {
          button.focus();
          button.setAttribute('focus-ring', '');
        }
        this._activeButton = null;
      }
    }

    _close(restoreFocus) {
      this.__deactivateButton(restoreFocus);
      this._subMenu.opened && this._subMenu.close();
    }
  };
</script>


